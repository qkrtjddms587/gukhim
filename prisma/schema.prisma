// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 1. ì†Œì† ë‹¨ì²´ (1ëìŠ¤)
model Organization {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  generations  Generation[]
  affiliations Affiliation[]
  createdAt    DateTime      @default(now())

  deletedAt DateTime?
  Post      Post[]
  position  Position[]
}

// 2. ê¸°ìˆ˜ (2ëìŠ¤)
model Generation {
  id             Int           @id @default(autoincrement())
  name           String // ì˜ˆ: "1ê¸°", "2026ë…„ ìƒë°˜ê¸°"
  organizationId Int
  organization   Organization  @relation(fields: [organizationId], references: [id])
  affiliations   Affiliation[]
  createdAt      DateTime      @default(now())

  deletedAt DateTime?

  @@unique([organizationId, name])
}

// 3. íšŒì› (ê³ ìœ  ì¸ë¬¼)
model Member {
  id Int @id @default(autoincrement())

  loginId  String @unique // ë¡œê·¸ì¸ìš© ì•„ì´ë””
  password String // ì•”í˜¸í™”ëœ ë¹„ë°€ë²ˆí˜¸

  name  String
  phone String  @unique // ì „í™”ë²ˆí˜¸ë¡œ ì‹ë³„
  email String? @unique

  image String?

  // ì™¸ë¶€ ì‚¬íšŒ ì •ë³´
  company String? // íšŒì‚¬ëª…
  job     String? // ì§ì¢…
  address String? // ì£¼ì†Œ

  affiliations    Affiliation[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  Post            Post[]
  Comment         Comment[]
  RefreshToken    RefreshToken[]
  LoginCode       LoginCode[]
  DevicePushToken DevicePushToken[]
}

// 4. ê°€ì… ì •ë³´ (ì¤‘ê°„ í…Œì´ë¸”)
model Affiliation {
  id                  Int             @id @default(autoincrement())
  memberId            Int
  member              Member          @relation(fields: [memberId], references: [id])
  organizationId      Int
  organization        Organization    @relation(fields: [organizationId], references: [id])
  generationId        Int
  generation          Generation      @relation(fields: [generationId], references: [id])
  role                String          @default("USER") // ADMIN,MANAGER,USER
  status              String          @default("ACTIVE")
  membershipExpiresAt DateTime?
  fees                MembershipFee[]

  greeting Greeting?

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  Position   Position? @relation(fields: [positionId], references: [id])
  positionId Int?

  @@unique([memberId, organizationId, generationId])
}

// 5. íšŒë¹„ ë‚©ë¶€ ë‚´ì—­
model MembershipFee {
  id            String      @id // PG Order ID (ì§ì ‘ ìƒì„±)
  affiliationId Int
  affiliation   Affiliation @relation(fields: [affiliationId], references: [id])
  amount        Int

  // ì´ ê²°ì œë¡œ ì¸í•´ ì–¸ì œë¶€í„° ì–¸ì œê¹Œì§€ ì—°ì¥ë˜ì—ˆëŠ”ì§€ ê¸°ë¡
  validFrom  DateTime
  validUntil DateTime

  status    String    @default("PENDING")
  pgTid     String?
  paidAt    DateTime?
  updatedAt DateTime  @updatedAt
}

model Post {
  id        Int    @id @default(autoincrement())
  title     String
  content   String // ë‚´ìš©ì€ í…ìŠ¤íŠ¸ ë˜ëŠ” HTML
  viewCount Int    @default(0)

  // ê²Œì‹œê¸€ íƒ€ì… (ê³µì§€ì‚¬í•­, ììœ ê²Œì‹œíŒ, í–‰ì‚¬ ë“±)
  type String @default("FREE")

  // ì‘ì„±ì ì •ë³´
  authorId Int
  author   Member @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // ì–´ëŠ ë‹¨ì²´ì˜ ê¸€ì¸ì§€
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])

  // ì´ë¯¸ì§€ì™€ ëŒ“ê¸€ (1:N)
  images   PostImage[]
  comments Comment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PostImage {
  id     Int    @id @default(autoincrement())
  url    String
  postId Int
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model Comment {
  id      Int    @id @default(autoincrement())
  content String

  memberId Int
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  postId Int
  post   Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Greeting {
  id Int @id @default(autoincrement())

  // ëˆ„êµ¬ì˜ ì¸ì‚¬ë§ì¸ê°€? (Affiliationì„ í†µí•˜ë©´ Member, Org, Gen ì •ë³´ë¥¼ í•œ ë²ˆì— ì•Œ ìˆ˜ ìˆìŒ)
  affiliationId Int         @unique // í•œ ëª…ì˜ íšŒì¥ì€ í•˜ë‚˜ì˜ ê¸°ìˆ˜ì— í•˜ë‚˜ì˜ ì¸ì‚¬ë§ë§Œ (í•„ìš”ì‹œ unique ì œê±°)
  affiliation   Affiliation @relation(fields: [affiliationId], references: [id], onDelete: Cascade)

  title    String? // ì¸ì‚¬ë§ ì œëª© (ì˜ˆ: "ì œ 5ëŒ€ íšŒì¥ ì·¨ì„ì‚¬")
  content  String // ì¸ì‚¬ë§ ë³¸ë¬¸ (HTML/Text)
  imageUrl String? // ì¸ì‚¬ë§ìš© íŠ¹ë³„ ì‚¬ì§„ (ê¸°ì¡´ í”„ë¡œí•„ê³¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)

  isActive Boolean @default(true) // í˜„ì¬ ë…¸ì¶œ ì—¬ë¶€

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Position {
  id Int @id @default(autoincrement())

  // ì–´ëŠ ì¡°ì§ì˜ ì§ì±…ì¸ì§€
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name        String // ì˜ˆ: "íšŒì¥", "ì‚¬ë¬´êµ­ì¥"
  rank        Int // ì„œì—´ (1: ìµœìƒìœ„, ìˆ«ìê°€ í´ìˆ˜ë¡ í•˜ìœ„)
  isExecutive Boolean @default(false) // ì„ì› ì—¬ë¶€

  // ğŸŒ³ [íŠ¸ë¦¬ êµ¬ì¡° í•µì‹¬] ìƒìœ„ ì§ì±…(Reports To) ì •ì˜
  parentId Int? // ìµœìƒìœ„(íšŒì¥)ë©´ null
  parent   Position?  @relation("PositionHierarchy", fields: [parentId], references: [id])
  children Position[] @relation("PositionHierarchy") // ë‚´ ë°‘ì˜ í•˜ìœ„ ì§ì±…ë“¤

  duesAmount Int @default(0)

  duesCycle String @default("NONE")

  // ì´ ì§ì±…ì„ ë§¡ì€ ì‚¬ëŒë“¤
  affiliations Affiliation[]

  @@unique([organizationId, name])
}

model RefreshToken {
  id         String    @id @default(cuid())
  memberId   Int
  tokenHash  String    @unique
  deviceId   String? // ë„¤ì´í‹°ë¸Œì—ì„œ ìƒì„±í•œ UUID(ê¶Œì¥)
  userAgent  String?
  ip         String?
  createdAt  DateTime  @default(now())
  expiresAt  DateTime
  revokedAt  DateTime?
  replacedBy String? // rotation ì‹œ ìƒˆ í† í° id ê¸°ë¡(ì„ íƒ)

  member Member @relation(fields: [memberId], references: [id])

  @@index([memberId])
  @@index([deviceId])
}

model LoginCode {
  code      String    @id // ëœë¤ê°’(ì¶©ë¶„íˆ ê¸¸ê²Œ)
  memberId  Int
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  member Member @relation(fields: [memberId], references: [id])

  @@index([memberId])
  @@index([expiresAt])
}

model DevicePushToken {
  id        String   @id @default(cuid())
  memberId  Int
  platform  String // ios | android
  token     String
  deviceId  String?
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  member Member @relation(fields: [memberId], references: [id])

  @@unique([platform, token])
  @@index([memberId])
}
